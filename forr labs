// Модуль объекта документа Продажи

// Процедура вызывается при изменении любого поля
Процедура ПриИзменении(ИсточникИзменения)
    РассчитатьБонус();
КонецПроцедуры

// Процедура расчета бонуса
Процедура РассчитатьБонус()
    
    // Проверяем, что есть что считать
    Если Сотрудник = Неопределено Тогда
        Бонус = 0;
        Возврат;
    КонецЕсли;
    
    Если СуммаПродаж = Неопределено Или СуммаПродаж <= 0 Тогда
        Бонус = 0;
        Возврат;
    КонецЕсли;
    
    // Получаем значения скидки и возврата
    ЗначСкидка = 0;
    Если Скидка <> Неопределено Тогда
        ЗначСкидка = Скидка;
    КонецЕсли;
    
    ЗначВозврат = 0;
    Если Возврат <> Неопределено Тогда
        ЗначВозврат = Возврат;
    КонецЕсли;
    
    // Считаем чистую сумму
    ЧистаяСумма = СуммаПродаж - ЗначСкидка - ЗначВозврат;
    
    // Если отрицательно - делаем 0
    Если ЧистаяСумма < 0 Тогда
        ЧистаяСумма = 0;
    КонецЕсли;
    
    // Бонус = 5% от чистой суммы
    Бонус = Окр(ЧистаяСумма * 0.05, 2);
    
КонецПроцедуры

// Процедура проведения документа
Процедура ОбработкаПроведения(Отказ, Режим)
    
    // Проверяем сотрудника
    Если Сотрудник = Неопределено Тогда
        Отказ = Истина;
        Сообщить("Не выбран сотрудник!");
        Возврат;
    КонецЕсли;
    
    // Проверяем сумму продаж
    Если СуммаПродаж = Неопределено Или СуммаПродаж <= 0 Тогда
        Отказ = Истина;
        Сообщить("Сумма продаж должна быть больше 0!");
        Возврат;
    КонецЕсли;
    
    // Рассчитываем бонус если еще не рассчитан
    Если Бонус = Неопределено Тогда
        РассчитатьБонус();
    КонецЕсли;
    
    // Обновляем бонус сотрудника в справочнике
    Попытка
        // Получаем объект сотрудника
        ОбъектСотрудника = Сотрудник.ПолучитьОбъект();
        
        // Текущий бонус сотрудника
        ТекущийБонус = 0;
        Если ОбъектСотрудника.Бонус <> Неопределено Тогда
            ТекущийБонус = ОбъектСотрудника.Бонус;
        КонецЕсли;
        
        // Увеличиваем бонус
        ОбъектСотрудника.Бонус = ТекущийБонус + Бонус;
        
        // Сохраняем
        ОбъектСотрудника.Записать();
        
        Сообщить("Бонус сотрудника увеличен на: " + Бонус);
        
    Исключение
        // Если ошибка - просто сообщаем, но документ проводим
        Сообщить("Не удалось обновить бонус сотрудника");
    КонецПопытки;
    
КонецПроцедуры