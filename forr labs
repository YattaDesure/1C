// Модуль объекта документа Продажи
// ВСТАВЬ ВЕСЬ ЭТОТ КОД, УДАЛИВ СТАРЫЙ

// Процедура вызывается перед записью документа
Процедура ПередЗаписью(Отказ)
    
    // Автоматически рассчитываем бонус при записи
    Если Сотрудник <> Неопределено И СуммаПродаж > 0 Тогда
        РассчитатьБонус();
    КонецЕсли;
    
КонецПроцедуры

// Процедура расчета бонуса
Процедура РассчитатьБонус()
    
    // Получаем значение скидки
    ЗначСкидка = 0;
    Если Скидка <> Неопределено Тогда
        ЗначСкидка = Скидка;
    КонецЕсли;
    
    // Получаем значение возврата
    ЗначВозврат = 0;
    Если Возврат <> Неопределено Тогда
        ЗначВозврат = Возврат;
    КонецЕсли;
    
    // Рассчитываем чистую сумму
    ЧистаяСумма = СуммаПродаж - ЗначСкидка - ЗначВозврат;
    
    // Если чистая сумма отрицательная, делаем 0
    Если ЧистаяСумма < 0 Тогда
        ЧистаяСумма = 0;
    КонецЕсли;
    
    // Бонус = 5% от чистой суммы
    Бонус = Окр(ЧистаяСумма * 0.05, 2);
    
КонецПроцедуры

// Процедура проведения документа
Процедура ОбработкаПроведения(Отказ, Режим)
    
    // Проверяем, выбран ли сотрудник
    Если Сотрудник = Неопределено Тогда
        Отказ = Истина;
        Сообщить("Не выбран сотрудник!");
        Возврат;
    КонецЕсли;
    
    // Проверяем сумму продаж
    Если СуммаПродаж <= 0 Тогда
        Отказ = Истина;
        Сообщить("Сумма продаж должна быть больше 0!");
        Возврат;
    КонецЕсли;
    
    // Если бонус еще не рассчитан, рассчитываем
    Если Бонус = Неопределено Тогда
        РассчитатьБонус();
    КонецЕсли;
    
    // Обновляем бонус сотрудника в справочнике
    Попытка
        // Получаем объект сотрудника
        ОбъектСотрудника = Сотрудник.ПолучитьОбъект();
        
        // Получаем текущий бонус
        ТекущийБонус = 0;
        Если ОбъектСотрудника.Бонус <> Неопределено Тогда
            ТекущийБонус = ОбъектСотрудника.Бонус;
        КонецЕсли;
        
        // Увеличиваем бонус
        ОбъектСотрудника.Бонус = ТекущийБонус + Бонус;
        
        // Сохраняем
        ОбъектСотрудника.Записать();
        
    Исключение
        // Если ошибка, просто продолжаем
        Сообщить("Не удалось обновить бонус сотрудника");
    КонецПопытки;
    
КонецПроцедуры