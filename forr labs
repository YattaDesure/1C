Процедура ОбработкаПроведения(Отказ, Режим)
    
    // ===== ПРОВЕРКИ =====
    Если Сотрудник = Неопределено Тогда
        Отказ = Истина;
        Сообщить("Не выбран сотрудник!");
        Возврат;
    КонецЕсли;
    
    Если СуммаПродаж <= 0 Тогда
        Отказ = Истина;
        Сообщить("Сумма продаж должна быть больше 0!");
        Возврат;
    КонецЕсли;
    
    // ===== РАСЧЕТ БОНУСА =====
    // Получаем значения с проверкой
    ЗначСкидка = 0;
    ЗначВозврат = 0;
    
    Если Скидка <> Неопределено Тогда
        ЗначСкидка = Скидка;
    КонецЕсли;
    
    Если Возврат <> Неопределено Тогда
        ЗначВозврат = Возврат;
    КонецЕсли;
    
    // Чистая сумма
    ЧистаяСумма = СуммаПродаж - ЗначСкидка - ЗначВозврат;
    
    // Если чистая сумма отрицательная
    Если ЧистаяСумма < 0 Тогда
        ЧистаяСумма = 0;
    КонецЕсли;
    
    // Бонус = 5% от чистой суммы
    Бонус = Окр(ЧистаяСумма * 0.05, 2);
    
    // ===== СОХРАНЕНИЕ БОНУСА СОТРУДНИКА =====
    Попытка
        // Получаем объект сотрудника из справочника
        ВыбранныйСотрудник = Сотрудник.ПолучитьОбъект();
        
        // Получаем текущий бонус сотрудника
        ТекущийБонус = 0;
        Если ВыбранныйСотрудник.Бонус <> Неопределено Тогда
            ТекущийБонус = ВыбранныйСотрудник.Бонус;
        КонецЕсли;
        
        // Увеличиваем бонус
        НовыйБонус = ТекущийБонус + Бонус;
        
        // Сохраняем в справочнике
        ВыбранныйСотрудник.Бонус = НовыйБонус;
        ВыбранныйСотрудник.Записать();
        
        // Сообщаем об успехе
        Сообщить("Бонус сотрудника обновлен! Новый бонус: " + НовыйБонус);
        
    Исключение
        // Если ошибка - отменяем проведение
        Отказ = Истина;
        Сообщить("Ошибка при обновлении бонуса: " + ОписаниеОшибки());
    КонецПопытки;
    
КонецПроцедуры