&НаКлиенте
Процедура СуммаПродажПриИзменении(Элемент)
    РассчитатьБонусНаКлиенте();
КонецПроцедуры

&НаКлиенте
Процедура СкидкаПриИзменении(Элемент)
    РассчитатьБонусНаКлиенте();
КонецПроцедуры

&НаКлиенте
Процедура ВозвратПриИзменении(Элемент)
    РассчитатьБонусНаКлиенте();
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьБонусНаКлиенте()
    
    // Получаем форму
    Форма = ЭтотОбъект;
    
    // Получаем значения через объект документа
    ОбъектДокумента = Форма.Объект;
    
    // Проверяем сумму продаж
    Если ОбъектДокумента.СуммаПродаж <= 0 Тогда
        Форма.ЭлементыФормы.Бонус.Значение = 0;
        Возврат;
    КонецЕсли;
    
    // Получаем значения с проверкой на неопределено
    Сумма = ОбъектДокумента.СуммаПродаж;
    Скидка = ?(ОбъектДокумента.Скидка = Неопределено, 0, ОбъектДокумента.Скидка);
    ВозвратЗначение = ?(ОбъектДокумента.Возврат = Неопределено, 0, ОбъектДокумента.Возврат);
    
    // Рассчитываем чистую сумму
    ЧистаяСумма = Сумма - Скидка - ВозвратЗначение;
    
    // Если чистая сумма отрицательная
    Если ЧистаяСумма < 0 Тогда
        Форма.ЭлементыФормы.Бонус.Значение = 0;
        Возврат;
    КонецЕсли;
    
    // Рассчитываем бонус (5%)
    БонусРассчитанный = ЧистаяСумма * 0.05;
    БонусРассчитанный = Окр(БонусРассчитанный, 2);
    
    // Устанавливаем в поле формы
    Форма.ЭлементыФормы.Бонус.Значение = БонусРассчитанный;
    
    // Сохраняем в объект документа
    ОбъектДокумента.Бонус = БонусРассчитанный;
    
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РегистрПроведения)
    
    // Проверка обязательных полей
    Если Сотрудник = Неопределено Тогда
        Отказ = Истина;
        Сообщить("Не выбран сотрудник!");
        Возврат;
    КонецЕсли;
    
    Если СуммаПродаж <= 0 Тогда
        Отказ = Истина;
        Сообщить("Сумма продаж должна быть больше 0!");
        Возврат;
    КонецЕсли;
    
    // Если бонус не рассчитан - рассчитываем
    Если Бонус = Неопределено Или Бонус = 0 Тогда
        // Рассчитываем бонус
        ЗначСкидка = ?(Скидка = Неопределено, 0, Скидка);
        ЗначВозврат = ?(Возврат = Неопределено, 0, Возврат);
        ЧистаяСумма = СуммаПродаж - ЗначСкидка - ЗначВозврат;
        
        Если ЧистаяСумма < 0 Тогда
            Бонус = 0;
        Иначе
            Бонус = Окр(ЧистаяСумма * 0.05, 2);
        КонецЕсли;
    КонецЕсли;
    
    // Обновляем бонус сотрудника в справочнике
    Попытка
        // Получаем объект сотрудника
        СотрудникОбъект = Сотрудник.ПолучитьОбъект();
        
        // Увеличиваем бонус
        Если СотрудникОбъект.Бонус = Неопределено Тогда
            СотрудникОбъект.Бонус = Бонус;
        Иначе
            СотрудникОбъект.Бонус = СотрудникОбъект.Бонус + Бонус;
        КонецЕсли;
        
        // Сохраняем изменения
        СотрудникОбъект.Записать();
        
    Исключение
        Сообщить("Ошибка при обновлении бонуса сотрудника: " + ОписаниеОшибки());
        Отказ = Истина;
    КонецПопытки;
    
КонецПроцедуры