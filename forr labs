&НаКлиенте
Процедура СуммаПродажПриИзменении(Элемент)
    РассчитатьБонус();
КонецПроцедуры

&НаКлиенте
Процедура СкидкаПриИзменении(Элемент)
    РассчитатьБонус();
КонецПроцедуры

&НаКлиенте
Процедура ВозвратПриИзменении(Элемент)
    РассчитатьБонус();
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьБонус()
    
    // Получаем значения из формы
    СуммаПродажЗнач = ЭлементыФормы.СуммаПродаж.Значение;
    СкидкаЗнач = ЭлементыФормы.Скидка.Значение;
    ВозвратЗнач = ЭлементыФормы.Возврат.Значение;
    
    // Проверяем, что сумма продаж указана
    Если СуммаПродажЗнач = Неопределено ИЛИ СуммаПродажЗнач <= 0 Тогда
        ЭлементыФормы.Бонус.Значение = 0;
        Возврат;
    КонецЕсли;
    
    // Если скидка не указана, считаем её 0
    Если СкидкаЗнач = Неопределено Тогда
        СкидкаЗнач = 0;
    КонецЕсли;
    
    // Если возврат не указан, считаем его 0
    Если ВозвратЗнач = Неопределено Тогда
        ВозвратЗнач = 0;
    КонецЕсли;
    
    // Рассчитываем чистую сумму: Продажи - Скидка - Возврат
    ЧистаяСумма = СуммаПродажЗнач - СкидкаЗнач - ВозвратЗнач;
    
    // Если чистая сумма отрицательная - бонус 0
    Если ЧистаяСумма < 0 Тогда
        ЭлементыФормы.Бонус.Значение = 0;
        Возврат;
    КонецЕсли;
    
    // Рассчитываем бонус: 5% от чистой суммы
    БонусРассчитанный = ЧистаяСумма * 0.05;
    БонусРассчитанный = Окр(БонусРассчитанный, 2);
    
    // Устанавливаем бонус в поле формы
    ЭлементыФормы.Бонус.Значение = БонусРассчитанный;
    
КонецПроцедуры

// Модуль документа Продажи
Процедура ОбработкаПроведения(Отказ, Режим)
    
    // Проверяем обязательные поля
    Если Сотрудник = Неопределено Тогда
        Отказ = Истина;
        Сообщить("Не выбран сотрудник!");
        Возврат;
    КонецЕсли;
    
    Если СуммаПродаж <= 0 Тогда
        Отказ = Истина;
        Сообщить("Сумма продаж должна быть больше 0!");
        Возврат;
    КонецЕсли;
    
    // Рассчитываем бонус
    // Если скидка или возврат не указаны - считаем их 0
    ЗначСкидка = ?(Скидка = Неопределено, 0, Скидка);
    ЗначВозврат = ?(Возврат = Неопределено, 0, Возврат);
    
    // Чистая сумма = Продажи - Скидка - Возврат
    ЧистаяСумма = СуммаПродаж - ЗначСкидка - ЗначВозврат;
    
    // Если чистая сумма отрицательная - бонус 0
    Если ЧистаяСумма < 0 Тогда
        Бонус = 0;
    Иначе
        // Бонус = 5% от чистой суммы
        Бонус = Окр(ЧистаяСумма * 0.05, 2);
    КонецЕсли;
    
    // Обновляем бонус сотрудника в справочнике
    СотрудникОбъект = Сотрудник.ПолучитьОбъект();
    СотрудникОбъект.Бонус = СотрудникОбъект.Бонус + Бонус;
    СотрудникОбъект.Записать();
    
КонецПроцедуры