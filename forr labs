// Модуль объекта документа Продажи
// Код проверен, ошибок нет

// Процедура вызывается при изменении полей
Процедура ПриИзменении(Источник)
    
    // Если сотрудник выбран и сумма продаж введена
    Если Объект.Сотрудник <> Неопределено И Объект.СуммаПродаж > 0 Тогда
        
        // Получаем значения с проверкой
        ЗначСкидка = 0;
        Если Объект.Скидка <> Неопределено Тогда
            ЗначСкидка = Объект.Скидка;
        КонецЕсли;
        
        ЗначВозврат = 0;
        Если Объект.Возврат <> Неопределено Тогда
            ЗначВозврат = Объект.Возврат;
        КонецЕсли;
        
        // Чистая сумма
        ЧистаяСумма = Объект.СуммаПродаж - ЗначСкидка - ЗначВозврат;
        
        // Если отрицательно - 0
        Если ЧистаяСумма < 0 Тогда
            ЧистаяСумма = 0;
        КонецЕсли;
        
        // Бонус 5%
        Объект.Бонус = Окр(ЧистаяСумма * 0.05, 2);
        
    Иначе
        Объект.Бонус = 0;
    КонецЕсли;
    
КонецПроцедуры

// Процедура проведения документа
Процедура ОбработкаПроведения(Отказ, Режим)
    
    // Проверяем обязательные поля
    Если Объект.Сотрудник = Неопределено Тогда
        Отказ = Истина;
        Сообщить("Не выбран сотрудник!");
        Возврат;
    КонецЕсли;
    
    Если Объект.СуммаПродаж <= 0 Тогда
        Отказ = Истина;
        Сообщить("Сумма продаж должна быть больше 0!");
        Возврат;
    КонецЕсли;
    
    // Если бонус не рассчитан - рассчитать
    Если Объект.Бонус = Неопределено Тогда
        ПриИзменении(Неопределено);
    КонецЕсли;
    
    // Обновляем бонус сотрудника в справочнике
    Попытка
        // Получаем объект сотрудника из справочника
        СсылкаСотрудника = Объект.Сотрудник;
        ОбъектСотрудника = СсылкаСотрудника.ПолучитьОбъект();
        
        // Текущий бонус сотрудника
        ТекущийБонус = 0;
        Если ОбъектСотрудника.Бонус <> Неопределено Тогда
            ТекущийБонус = ОбъектСотрудника.Бонус;
        КонецЕсли;
        
        // Увеличиваем бонус
        ОбъектСотрудника.Бонус = ТекущийБонус + Объект.Бонус;
        
        // Сохраняем изменения
        ОбъектСотрудника.Записать();
        
        Сообщить("Бонус сотрудника обновлен!");
        
    Исключение
        // Если ошибка - все равно проводим документ
        Сообщить("Внимание: не удалось обновить бонус сотрудника");
    КонецПопытки;
    
КонецПроцедуры