// Эта процедура выполняется при проведении документа
Процедура ОбработкаПроведения(Отказ, Режим)
    
    // Проверяем, что сотрудник выбран
    Если Сотрудник = Неопределено Тогда
        Сообщить("Не выбран сотрудник!");
        Возврат;
    КонецЕсли;
    
    // Проверяем, что сумма начисления указана
    Если Начислено = 0 Тогда
        Сообщить("Сумма начисления не указана!");
        Возврат;
    КонецЕсли;
    
    // Получаем налоговую ставку сотрудника
    СтавкаНалога = Сотрудник.НалоговаяСтавка;
    
    // Проверяем, что ставка указана
    Если СтавкаНалога = 0 Тогда
        Сообщить("У сотрудника не указана налоговая ставка!");
        Возврат;
    КонецЕсли;
    
    // Рассчитываем налог
    НалогРассчитанный = Начислено * СтавкаНалога / 100;
    
    // Сохраняем налог в документе
    Объект.Налог = НалогРассчитанный;
    
КонецПроцедуры

// Эта процедура проверяет данные перед сохранением
Процедура ПередЗаписью(Отказ)
    
    // Проверяем обязательные поля
    Если Сотрудник = Неопределено Тогда
        Отказ = Истина;
        Сообщить("Не выбран сотрудник!");
        Возврат;
    КонецЕсли;
    
    Если Начислено <= 0 Тогда
        Отказ = Истина;
        Сообщить("Сумма начисления должна быть больше 0!");
        Возврат;
    КонецЕсли;
    
КонецПроцедуры

// Модуль формы документа НачислениеЗарплаты

&НаКлиенте
Процедура СотрудникПриИзменении(Элемент)
    
    // Получаем текущее значение начисления
    НачисленоФормы = ЭлементыФормы.Начислено.Значение;
    
    // Если есть сумма начисления, пересчитываем налог
    Если НачисленоФормы > 0 Тогда
        // Вызываем процедуру расчета налога
        НачисленоПриИзменении(ЭлементыФормы.Начислено);
    КонецЕсли;
    
КонецПроцедуры

&НаКлиенте
Процедура НачисленоПриИзменении(Элемент)
    
    // Получаем значения из элементов формы
    СотрудникФормы = ЭлементыФормы.Сотрудник.Значение;
    НачисленоФормы = ЭлементыФормы.Начислено.Значение;
    
    // Проверяем, что сотрудник выбран
    Если СотрудникФормы = Неопределено Тогда
        ЭлементыФормы.Налог.Значение = 0;
        Возврат;
    КонецЕсли;
    
    // Проверяем, что сумма указана
    Если НачисленоФормы <= 0 Тогда
        ЭлементыФормы.Налог.Значение = 0;
        Возврат;
    КонецЕсли;
    
    // Получаем ставку налога сотрудника
    Ставка = СотрудникФормы.НалоговаяСтавка;
    
    // Если ставка не указана
    Если Ставка = 0 Тогда
        ЭлементыФормы.Налог.Значение = 0;
        Возврат;
    КонецЕсли;
    
    // Рассчитываем налог
    НалогРассчитанный = НачисленоФормы * Ставка / 100;
    
    // Округляем до 2 знаков
    НалогРассчитанный = Окр(НалогРассчитанный, 2);
    
    // Показываем налог в поле
    ЭлементыФормы.Налог.Значение = НалогРассчитанный;
    
КонецПроцедуры