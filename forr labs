// Модуль объекта документа Продажи
// Полный рабочий код со всеми ссылками

// Процедура вызывается при изменении любого поля
Процедура ПриИзменении(Источник)
    
    // Если есть сотрудник и сумма продаж
    Если Объект.Сотрудник <> Неопределено И Объект.СуммаПродаж > 0 Тогда
        
        // Получаем скидку (если не указана - 0)
        Если Объект.Скидка = Неопределено Тогда
            ЗначениеСкидки = 0;
        Иначе
            ЗначениеСкидки = Объект.Скидка;
        КонецЕсли;
        
        // Получаем возврат (если не указан - 0)
        Если Объект.Возврат = Неопределено Тогда
            ЗначениеВозврата = 0;
        Иначе
            ЗначениеВозврата = Объект.Возврат;
        КонецЕсли;
        
        // Считаем чистую сумму
        ЧистаяСумма = Объект.СуммаПродаж - ЗначениеСкидки - ЗначениеВозврата;
        
        // Если чистая сумма меньше 0, делаем 0
        Если ЧистаяСумма < 0 Тогда
            ЧистаяСумма = 0;
        КонецЕсли;
        
        // Бонус = 5% от чистой суммы
        Объект.Бонус = Окр(ЧистаяСумма * 0.05, 2);
        
    Иначе
        // Если условий нет - бонус 0
        Объект.Бонус = 0;
    КонецЕсли;
    
КонецПроцедуры

// Процедура проведения документа
Процедура ОбработкаПроведения(Отказ, Режим)
    
    // Проверяем обязательные поля
    Если Объект.Сотрудник = Неопределено Тогда
        Отказ = Истина;
        Сообщить("Не выбран сотрудник!");
        Возврат;
    КонецЕсли;
    
    Если Объект.СуммаПродаж <= 0 Тогда
        Отказ = Истина;
        Сообщить("Сумма продаж должна быть больше 0!");
        Возврат;
    КонецЕсли;
    
    // Если бонус не рассчитан - рассчитать
    Если Объект.Бонус = Неопределено Тогда
        ПриИзменении(Неопределено);
    КонецЕсли;
    
    // Обновляем бонус сотрудника в справочнике
    Попытка
        // Получаем ссылку на сотрудника
        СсылкаНаСотрудника = Объект.Сотрудник;
        
        // Получаем объект сотрудника
        ОбъектСотрудника = СсылкаНаСотрудника.ПолучитьОбъект();
        
        // Текущий бонус сотрудника
        Если ОбъектСотрудника.Бонус = Неопределено Тогда
            ТекущийБонусСотрудника = 0;
        Иначе
            ТекущийБонусСотрудника = ОбъектСотрудника.Бонус;
        КонецЕсли;
        
        // Увеличиваем бонус
        НовыйБонусСотрудника = ТекущийБонусСотрудника + Объект.Бонус;
        ОбъектСотрудника.Бонус = НовыйБонусСотрудника;
        
        // Сохраняем
        ОбъектСотрудника.Записать();
        
        Сообщить("Бонус сотрудника увеличен на: " + Объект.Бонус);
        
    Исключение
        Сообщить("Не удалось обновить бонус сотрудника, но документ проведен");
    КонецПопытки;
    
КонецПроцедуры